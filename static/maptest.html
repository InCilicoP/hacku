<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Test Map</title>
    <script>
      var socket = new WebSocket("ws://localhost:8080/ws");
      socket.onopen = function() {
          console.log('openしたよ');
          var testJson3 = {
            key:'reqGomis',
            value:['AZ37','discord_teck'],
          };
          socket.send(JSON.stringify(testJson3));
      };
      socket.onmessage = function(message){
        messageAry = JSON.parse(message.data);
        console.log(messageAry);
        var nodes = [];
        for(i=0;i<messageAry.value.length;i++){
          var check = 0;
          nodes.forEach(function(node){
            if(node.word == messageAry.value[i].word){check++}
          });
          if(check<1){
            id:i,
            nodes.push({word:messageAry.value[i].word});
          }
        }
        force(nodes)
      }
    </script>
  </head>
  <body>
    <script src="http://d3js.org/d3.v3.js" charset="utf-8"></script>
    <script>
      var force = function(nodes){
        var w = 800;
        var h = 800;
        //var nodes = [ {id:0}, {id:1}, {id:2}, {id:3} ];
        var links = [
                    ];
       var force = d3.layout.force()
                     .nodes(nodes)
                     .links(links)
                     .size([w, h])
                     .linkStrength(0.1)
                     .friction(0.9)
                     .distance(200)
                     .charge(-300)
                     .gravity(0.1)
                     .theta(0.8)
                     .alpha(0.1)
                     .start();
        var svg = d3.select("body").append("svg").attr({width:w, height:h});
        var link = svg.selectAll("line")
                      .data(links)
                      .enter()
                      .append("line")
                      .attr({opacity:0})
                      .style({stroke: "#ccc",
                              "stroke-width": 1});
        var node = svg.selectAll("circle")
                      .data(nodes)
                      .enter()
                      .append("circle")
                      .attr({r: 20,
                             opacity: 0})
                      .style({fill: "red"})
                      .call(force.drag);
        var label = svg.selectAll('text')
                      .data(nodes)
                      .enter()
                      .append('text')
                      .attr({"text-anchor":"middle","fill":"black"})
                      .style({"font-size":11})
                      .text(function(d) { return d.word;});
        var node2 = svg.selectAll('circle')
          .data(nodes)
          .enter()
          .append('circle')
          .attr({r:100,opacity:0.2})
          .style({fill:'blue'})
          .call(force.drag);
        force.on("tick", function() {
          link.attr({x1: function(d) { return d.source.x; },
                     y1: function(d) { return d.source.y; },
                     x2: function(d) { return d.target.x; },
                     y2: function(d) { return d.target.y; }});
          node.attr({cx: function(d) { return d.x; },
                     cy: function(d) { return d.y; }});
          label.attr({x: function(d) { return d.x; },
                      y: function(d) { return d.y; }});
          node2.attr({cx: function(d) { return d.x; },
                     cy: function(d) { return d.y; }});
        });
      }
  </script>
  </body>
</html>
